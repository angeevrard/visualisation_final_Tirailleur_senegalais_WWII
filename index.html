<!DOCTYPE html>
<html lang="fr">
<head>
    <title>Visualisation Web-SIG Tirailleurs S√©n√©galais</title>
    <meta property="og:description" content="Visualisation interactive des lieux de d√©c√®s et de naissance des Tirailleurs S√©n√©galais." />
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.13.0/dist/maplibre-gl.css' />
    <script src='https://unpkg.com/maplibre-gl@5.13.0/dist/maplibre-gl.js'></script>
    <style>
        /* Styles pour le corps et la carte */
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, 'Geneva', Verdana, sans-serif;}
        html, body, #map { height: 100%; }

        /* Styles de la Sidebar (Division B : Carte de l'Afrique) */
            .rounded-rect { background:black; border-radius: 10px; box-shadow: 0 0 50px -25px black; }
            .flex-center { position: absolute; display: flex; justify-content: center; align-items: center; }
            .flex-center.right { right: 0px; }
            .sidebar-content { position: absolute; width: 95%; height: 95%; overflow: hidden; display: flex; flex-direction: column; }
        
                /* Styles d'affichage des statique de la carte d'Afrique */
                #afrique-message { color: white; padding: 15px; text-align: left; font-size: 1.5em; overflow-y: auto; max-height: 20%;}
                #afrique-message ul {list-style-type: none; padding-left: 0;}
                #afrique-message li {margin-bottom: 5px; padding: 3px 5px; border-radius: 3px;}

                /* Conteneur de la carte Afrique */
                #map-afrique-container { width: 100%; height: 80%;}
                #map-afrique {width: 100%; height: 100%;}
            
                /* Styles du bouton de la sidebar */
                .sidebar-toggle { position: absolute; width: 3em; height: 3em; overflow: visible; display: flex; justify-content: center; align-items: center; color : white; background: black; border-radius: 50%; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); z-index: 15; font-size: 2em; font-weight: bold }
                .sidebar-toggle.right { left: -0.7em; }
                .sidebar-toggle:hover { color: #0aa1cf; cursor: pointer; background-color: #333 }
                .sidebar { transition: transform 1s; z-index: 10; width: 600px; height: 100%; }
                .right.collapsed {transform: translateX(595px); }

        /* Styles de la Division C (Contr√¥les Temporels) */
            #controle_temporel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60%; 
            height: 25%; 
            background-color:#334e68;
            z-index: 5;
            padding: 10px;
            box-sizing: border-box;
            display: flex; 
            flex-direction: column;
            justify-content: space-around;
            }
            .echelle-container { display: flex; align-items: center; gap: 50px; }
            .bouton-defilement {  align-items: center; appearance: none; background-color: #fff; border-radius: 12px; border-style: none; 
                box-shadow: rgba(0, 0, 0, .2) 0 3px 5px -1px,rgba(0, 0, 0, .14) 0 6px 10px 0,rgba(0, 0, 0, .12) 0 1px 18px 0;
                box-sizing: border-box;
                color: #3c4043;
                cursor: pointer;
                display: inline-flex;
                fill: currentcolor;
                font-family: 'Segoe UI', Tahoma, 'Geneva', Verdana, sans-serif;
                font-size: 14px;
                font-weight: 500;
                height: 48px;
                justify-content: center;
                letter-spacing: .25px;
                line-height: normal;
                max-width: 100%;
                overflow: visible;
                padding: 2px 24px;
                position: relative;
                text-align: center;
                text-transform: none;
                transition: box-shadow 280ms cubic-bezier(.4, 0, .2, 1),opacity 15ms linear 30ms,transform 270ms cubic-bezier(0, 0, .2, 1) 0ms;
                user-select: none;
                -webkit-user-select: none;
                touch-action: manipulation;
                width: auto;
                will-change: transform,opacity;
                z-index: 0;}
            .bouton-defilement:hover{background: #F6F9FE; color: #174ea6;}
            .bouton-defilement:active{box-shadow: 0 4px 4px 0 rgb(60 64 67 / 30%), 0 8px 12px 6px rgb(60 64 67 / 15%);outline: none;}    
            .button-17:focus {outline: none; border: 2px solid #4285f4;}
            .bouton-defilement:not(:disabled) {box-shadow: rgba(226, 229, 232, 0.986) 0 1px 3px 0, rgba(60, 64, 67, .15) 0 4px 8px 3px;}
            .bouton-defilement:not(:disabled):hover {box-shadow: rgba(201, 204, 206, 0.765) 0 2px 3px 0, rgba(210, 213, 215, 0.783) 0 2px 10px 4px;}
            .bouton-defilement:not(:disabled):focus {box-shadow: rgba(60, 64, 67, .3) 0 1px 3px 0, rgba(60, 64, 67, .15) 0 4px 8px 3px;}
            .bouton-defilement:not(:disabled):active {box-shadow: rgba(201, 204, 206, 0.765) 0 2px 3px 0, rgba(210, 213, 215, 0.783) 0 2px 10px 4px;}
            .bouton-defilement:disabled {box-shadow: rgba(60, 64, 67, .3) 0 1px 3px 0, rgba(60, 64, 67, .15) 0 4px 8px 3px;}
            .timeline {display: flex; align-items: center; position: relative; flex-grow: 1; justify-content: space-around;}
            .timeline-item { 
                width: 25px; 
                height: 25px; 
                border-radius: 50%; 
                background-color: #CCCCCC;
                display: flex; 
                justify-content: center; 
                align-items: center; 
                font-size: 10px; 
                color: white; 
                cursor: pointer; 
                position: relative; 
                transition: background-color 0.3s, transform 0.3s; 
            }
            .timeline-item.active {transform: scale(1.2); box-shadow: 0 0 5px #0aa1cf;}
            .timeline-label { position: absolute; bottom: -20px; font-size: 13px; white-space: nowrap;height: 3px; }
            .timeline-count {position: absolute; top: -40px; font-size: 18px; font-weight: bold; color: #de0e0e; white-space: nowrap; display: none; /* Cach√© par d√©faut */}

            .echelle-barre {
            display: flex;
            text-align: center;
            justify-content: space-between;
            padding-left: 12rem;
            background: #8B0000;
            border-radius: 10px;
            margin-bottom: 10px;
            transition: transform 0.2s;
            }

            .echelle-title {
            color: white;
            font-size: 15px;
            font-weight: 600;
            text-align: center;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            }

            /* Style personnalis√© popup Division A */
            .maplibregl-popup.popup-france .maplibregl-popup-content {
                padding: 0 ;
                border-radius: 3% ;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) ;
                overflow: hidden;
                min-width: 280px;
                font-family: 'Segoe UI', Tahoma, 'Geneva', Verdana, sans-serif;
            }

            .popup-header {
                background: linear-gradient(135deg, #334e68 0%, #1f3a56 50%, #0b1e2d 100%);
                padding: 20px;
                color: white;
                position: relative ;
            }


            .popup-commune {
                font-size: 1.5em;
                font-weight: bold;
                margin: 0;
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            }

            .popup-body {
                padding: 20px;
                background: white;
            }

            .popup-stat {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 15px;
                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                border-radius: 10px;
                margin-bottom: 15px;
                transition: transform 0.2s;
            }

            .popup-stat:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }

            .popup-stat-label {
                font-size: 0.95em;
                color: #555;
                font-weight: 500;
            }

            .popup-stat-value {
                font-size: 2em;
                font-weight: bold;
                color: #222225;
                text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            }
            
            .maplibregl-popup-close-button {
                background-color: rgba(255, 255, 255, 0.2);;   
                color: white;            
                font-size: 1.5em;          
                border-radius: 50%;      
                position: absolute;
                transition: background 0.2s;
            }

        /* Style du popup informatif √† l'ouverture de la visualisation */
            .popup-overlay {
                display: flex;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.85);
                justify-content: center;
                align-items: center;
                z-index: 2000;
                animation: fadeIn 0.3s ease;
            }

            .popup-overlay.hidden {
                display: none;
            }

            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }

            .popup-info {
                background: white;
                border-radius: 15px;
                padding: 40px;
                max-width: 700px;
                width: 90%;
                max-height: 85vh;
                overflow-y: auto;
                box-shadow: 0 10px 40px rgba(0,0,0,0.5);
                position: relative;
                animation: slideUp 0.4s ease;
            }

            @keyframes slideUp {
                from { transform: translateY(50px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }

            .popup-close-btn {
                position: absolute;
                top: 15px;
                right: 15px;
                background: none;
                border: none;
                font-size: 28px;
                cursor: pointer;
                color: #999;
                transition: color 0.3s;
                z-index: 10;
            }

            .popup-close-btn:hover {
                color: #333;
            }

            .popup-content-section {
                display: none;
            }

            .popup-content-section.active {
                display: block;
                animation: fadeInContent 0.3s ease;
            }

            @keyframes fadeInContent {
                from { opacity: 0; transform: translateX(20px); }
                to { opacity: 1; transform: translateX(0); }
            }

            .popup-info h2 {
                color: #1f3a56;
                margin-bottom: 20px;
                font-size: 1.8em;
                border-bottom: 3px solid #334e68;
                padding-bottom: 10px;
                 text-align: center; 
            }

            .popup-info h3 {
                color: #334e68;
                margin-top: 20px;
                margin-bottom: 10px;
                font-size: 1.3em;
            }

            .popup-info p {
                color: #555;
                line-height: 1.8;
                margin-bottom: 15px;
                font-size: 1.05em;
            }

            .popup-info ul {
                margin-left: 20px;
                margin-bottom: 15px;
            }

            .popup-info li {
                color: #555;
                line-height: 1.8;
                margin-bottom: 8px;
            }

            .popup-info strong {
                color: #1f3a56;
            }

            .feature-box {
                background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                padding: 15px;
                border-radius: 10px;
                margin: 15px 0;
                border-left: 4px solid #334e68;
            }

            .color-legend {
                display: flex;
                flex-wrap: wrap;
                gap: 15px;
                margin: 15px 0;
                padding-bottom: 2rem;
            }

            .color-item {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .color-box {
                width: 25px;
                height: 25px;
                border-radius: 5px;
                border: 2px solid #333;
            }

            .popup-navigation {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 30px;
                padding-top: 20px;
                border-top: 2px solid #eee;
            }

            .popup-dots-container {
                display: flex;
                gap: 10px;
            }

            .popup-dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                background: #ddd;
                cursor: pointer;
                transition: all 0.3s;
            }

            .popup-dot.active {
                background: #334e68;
                width: 30px;
                border-radius: 5px;
            }

            .popup-buttons-container {
                display: flex;
                gap: 10px;
            }

            .popup-btn {
                padding: 12px 25px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 1em;
                transition: all 0.3s;
                font-weight: 600;
            }

            .popup-btn-secondary {
                background: #f0f0f0;
                color: #666;
            }

            .popup-btn-secondary:hover {
                background: #e0e0e0;
            }

            .popup-btn-primary {
                background: linear-gradient(135deg, #334e68 0%, #1f3a56 100%);
                color: white;
            }

            .popup-btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(51, 78, 104, 0.4);
            }

            .popup-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

        /* Style pour la carte des concentration de d√©c√®s √† l'√©chelle des d√©partement */    

            /* Panneau Statistiques */
                .map-overlay {
                    position: fixed; 
                    background: rgba(255, 255, 255, 0.95);
                    border-radius: 10px;
                    box-shadow: 0 1px 10px rgba(0, 0, 0, 0.3);
                    padding: 15px;
                    font-family: 'Segoe UI', Tahoma, 'Geneva', Verdana, sans-serif;
                    z-index: 1;
                }

                #features {
                    top: 0.2rem;
                    left: 0.2rem;
                    width: 250px;
                    max-height: 200px;
                    overflow-y: auto;
                }

                #features h2 {
                    color: #1f3a56;
                    margin-bottom: 10px;
                    font-size: 16px;
                    border-bottom: 2px solid #334e68;
                    padding-bottom: 5px;
                }

                #features p {
                    margin: 8px 0;
                    color: #555;
                    font-size: 14px;
                    line-height: 1.5;
                }

                #features b {
                    color: #1f3a56;
                }

            /* L√©gende */
                #legend {
                    bottom: 40px;
                    right: 20px;
                    width: 280px;
                    padding: 15px;
                    background: rgba(41, 41, 41, 0.9);
                    color: white;
                    line-height: 1.5;
                }

                .legend-key {
                    display: inline-block;
                    width: 20px;
                    height: 15px;
                    margin-right: 8px;
                    vertical-align: middle;
                    border: 1px solid rgba(255, 255, 255, 0.3);
                    border-radius: 2px;
                }

                .legend-item {
                    margin-bottom: 6px;
                    font-size: 13px;
                }

                .legend-title {
                    font-weight: bold;
                    margin-bottom: 10px;
                    color: white;
                    font-size: 14px;
                }

                .section-title {
                    font-weight: bold;
                    margin-top: 12px;
                    margin-bottom: 6px;
                    color: #e0e0e0;
                    font-size: 12px;
                }

    </style>
</head>
<body>
    <!-- Popup informatif √† l'ouverture de la visualisation -->
        <div class="popup-overlay" id="popupOverlay">
            <div class="popup-info">
                <button class="popup-close-btn" onclick="closeInfoPopup()">&times;</button>
                
                <!-- Volet 1 -->
                <div class="popup-content-section active" id="section1">
                    <h2>üó∫Ô∏è Tutoriel de la visualisation </h2>
                    <p>Cette visualisation interactive vous permet d'explorer les <strong>communes de d√©c√®s</strong> et les <strong>origines</strong> des <strong>Tirailleurs S√©n√©galais</strong> pendant et apr√®s la Seconde Guerre mondiale (1939-1952).</p>
                    
                    <h3>Que montre la carte de la France ?</h3>
                    <p style= "padding-bottom: 1rem;">La carte montre dans un premier temps <strong>les d√©partements les plus "mortels"</strong> par <strong>unit√© de surface</strong>, et dans un second temps les diff√©rentes <strong>communes (744)</strong> repr√©sentants, les lieux o√π un ou plusieurs soldats sont <strong>tomb√©s au combat </strong>ou <strong>d√©c√©d√©s apr√®s la guerre</strong>.</p>
                    
                    <div class="feature-box">
                        <strong>üìå Informations Importantes</strong>
                        <p style="margin: 10px 0 0 0;">Les clusters de couleurs bleue (üü¶), jaune (üü®) et rose (üü•) sur la carte, repr√©sentent uniquement le nombre de soldats d√©c√©d√©s : <strong>4 737</strong>, avec le lieu de d√©c√®s connu. Cependant, un total de <strong>8 062 soldats d√©c√©d√©s</strong> a √©t√© r√©cens√© √† l'√©chelle de la France d'apr√®s le site : <strong><i>"M√©moire des Hommes du Minist√®re des Arm√©s Fran√ßais"</i></strong></p>
                    </div>
                </div>

                <!-- Volet 2 -->
                <div class="popup-content-section" id="section2">
                    <h2>Comment utiliser cette visualisation</h2>
                    
                    <h3><strong>1.</strong> Navigation sur la carte</h3>
                    <ul>
                        <li><strong>Zoomer/D√©zoomer :</strong> Utilisez la molette de la souris ou les boutons + et -</li>
                        <li><strong>D√©placer :</strong> Cliquez et faites glisser la carte</li>
                        <li><strong>Points individuels :</strong> Cliquez sur un point pour voir les d√©tails dans la commune</li>
                        <li><strong>Clusters (cercles avec chiffres) :</strong> Cliquez pour zoomer et voir les points individuels</li>
                    </ul>

                    <h3><strong>2.</strong> Filtrage temporel</h3>
                    <p>En bas de l'√©cran, utilisez la "timeline" pour filtrer les d√©c√®s par ann√©e :</p>
                    <ul>
                        <li><strong>Cliquez sur une ann√©e</strong> pour afficher uniquement les d√©c√®s de cette p√©riode</li>
                        <li><strong>Re-cliquez sur la m√™me ann√©e</strong> pour d√©sactiver le filtre & revenir √† l'√©tat initial</li>
                        <li><strong>Utilisez les boutons "Previous/Next"</strong> pour naviguer chronologiquement</li>
                    </ul>

                    <h3><strong>3.</strong> Carte des origines des soldats (Afrique)</h3>
                    <p>Lorsque vous cliquez sur une commune,  une barre lat√©rale s'ouvre √† droite de l'√©cran montrant les pays d'origine africains des soldats d√©c√©d√©s dans cette commune.</p>
                </div>

                <!-- Navigation -->
                <div class="popup-navigation">
                    <div class="popup-dots-container">
                        <span class="popup-dot active" onclick="goToSection(0)"></span>
                        <span class="popup-dot" onclick="goToSection(1)"></span>
                    </div>
                    <div class="popup-buttons-container">
                        <button class="popup-btn popup-btn-secondary" id="btnPrevSection" onclick="previousSection()" disabled>Pr√©c√©dent</button>
                        <button class="popup-btn popup-btn-primary" id="btnNextSection" onclick="nextSection()">Suivant</button>
                    </div>
                </div>
            </div>
        </div>

    <!-- html de la carte des concentration de d√©c√®s √† l'√©chelle des d√©partement -->
        <!-- Panneau Statistiques -->
        <div class="map-overlay" id="features">
            <h2>Statistiques locales</h2>
            <div id="info">
                <p><b>Survolez un d√©partement</b></p>
                <p>Les d√©tails s'afficheront ici</p>
            </div>
        </div>

        <!-- L√©gende -->
        <div class="map-overlay" id="legend">
            <div class="legend-title">Concentration de d√©c√®s (morts/100 km¬≤)</div>
            <hr style="margin: 8px 0; border-color: #666;">
            
            <div class="legend-item">
                <span class="legend-key" style="background-color: #fee5d8;"></span>
                0,014 √† 0,1
            </div>
            <div class="legend-item">
                <span class="legend-key" style="background-color: #fc8d62;"></span>
                0,1 √† 0,253
            </div>
            <div class="legend-item">
                <span class="legend-key" style="background-color: #d32020;"></span>
                0,253 √† 0,986
            </div>
            <div class="legend-item">
                <span class="legend-key" style="background-color: #67000d;"></span>
                0,986 √† 61,905
            </div>
            
            <div class="section-title">Limites administratives</div>
            <div class="legend-item">
                <span class="legend-key" style="background: none; border: 2px solid #808080;"></span>
                Limite de la France
            </div>
            <div class="legend-item">
                <span class="legend-key" style="background: none; border: 1px dashed #ffffff;"></span>
                Limite d√©partementale
            </div>
        </div>

    <!-- html de la map et timeline -->
        <div id="map">
            <div id="right" class="sidebar flex-center right collapsed">
                <div class="sidebar-content rounded-rect flex-center">
                    <div id="afrique-message"></div>
                    <div id="map-afrique-container">
                        <div id="map-afrique"></div>
                    </div>

                    <div
                        class="sidebar-toggle rounded-rect right"
                        onclick="toggleSidebar('right')"
                    >
                        &larr;
                    </div>
                </div>
            </div>
        </div>

        <div id="controle_temporel">
            <div class="echelle-barre">
                <span class="echelle-title">Filtrer selon l'ann√©e le nombre de soldats d√©c√©d√©s pendant et apr√®s la guerre </span>
            </div>
            <div class="echelle-container">
                <button id="prev-annee" class="bouton-defilement" onclick="defilerTemps('annee', -1)">Previous</button>
                <div id="timeline-annee" class="timeline"> </div>
                <button id="next-annee" class="bouton-defilement" onclick="defilerTemps('annee', 1)">Next</button>
            </div>
        </div>

    <script>

        // URL donn√©es
        const POINTS_DECES_URL = 'https://raw.githubusercontent.com/angeevrard/webmapping_tirailleurs_senegalais/main/points_deces_vrai_vrai.geojson'; 
        const AFRIQUE_GEOJSON_URL = 'https://raw.githubusercontent.com/angeevrard/webmapping_tirailleurs_senegalais/main/afrique.geojson'; 
        const CONCENTRATION_DECES_URL = 'https://raw.githubusercontent.com/angeevrard/webmapping_tirailleurs_senegalais/main/concentration_deces_departement_wgs84.geojson';
        const CONTOUR_FRANCE_URL = 'https://raw.githubusercontent.com/angeevrard/webmapping_tirailleurs_senegalais/main/contours_france.geojson';


        // Valeurs sp√©ciales : pour les cat√©gories ann√©e, mois, pays
            const ANNEE_INCONNUE_VALEUR = 9999;
            const PAYS_INCONNU_VALEUR = 'Inconnu';
    
        // Liste des ann√©es
            const ANNEES_CONNUES = [1939, 1940, 1941, 1942, 1943, 1944, 1945, 1946, 1952];
            const ANNEES = [...ANNEES_CONNUES, ANNEE_INCONNUE_VALEUR]; 

        // Statistiques des d√©c√®s
            const STATS_DECES = {
                annee: {
                    '1939':52, '1940': 2608, '1941': 598, '1942': 275, '1943': 216, 
                    '1944': 635, '1945': 206, '1946': 56, '1952': 1, 
                    '9999': 90  
                },
            };  
    
        // Mappage des couleurs pour la Timeline (Division C) 
            const COULEURS_ANNEES = {
                '1939': '#FF1744',
                '1940': '#1E88E5', 
                '1941': '#00E676',
                '1942':'#D500F9',
                '1943':'#FFEB3B',
                '1944':'#00B0FF',
                '1945':'#7C4DFF',
                '1946':'#FF4D4D',
                '1952': '#4DD0E1',
                '9999': '#FF6D00' 
            };   
    
        // NOUVEAU: Variable pour stocker toutes les features (points) une fois charg√©es
            let allPointsFeatures = []; 
            
            let currentIndexAnnee = -1;  

        // Carte France (Division A) 
            const map = new maplibregl.Map({
                container: 'map',
                style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json', 
                center: [6.506929,44.80], 
                zoom: 4.9,
                padding: { bottom: window.innerHeight * 0.1 } 
            });

        // Carte Afrique (Division B) 
            const mapAfrique = new maplibregl.Map({
                container: 'map-afrique',
                style: 'https://basemaps.cartocdn.com/gl/positron-nolabels-gl-style/style.json',
                center: [16.614042, 0.5], 
                zoom: 2.5,
                attributionControl: false 
            });


        // Gestion des Donn√©es et des Couches (map.on('load')) 
            map.on('load', async () => {
                
                // Ajout de la source des points de d√©c√®s (sous forme de cluster)
                    map.addSource('deces-points', {
                        type: 'geojson',
                        data: POINTS_DECES_URL,
                        cluster: true, 
                        clusterMaxZoom: 10, 
                        clusterRadius: 50
                    });

                // Charger toutes les features dans allPointsFeatures
                    const response = await fetch(POINTS_DECES_URL);
                    const geojson = await response.json();
                    allPointsFeatures = geojson.features;

                // Couches d'affichage des points (clusters et points simple)
                    map.addLayer({ /* clusters */ id: 'clusters', type: 'circle', source: 'deces-points', filter: ['has', 'point_count'], paint: {
                        'circle-color': ['step', ['get', 'point_count'], '#51bbd6', 100, '#f1f075', 750, '#f28cb1'],
                        'circle-radius': ['step', ['get', 'point_count'], 20, 100, 30, 750, 40]
                    }});

                    map.addLayer({ /* clusters-count */ id: 'cluster-count', type: 'symbol', source: 'deces-points', filter: ['has', 'point_count'], layout: {
                        'text-field': '{point_count_abbreviated}',
                        'text-font': ['Segoe UI, Tahoma, Geneva, Verdana, sans-serif'],
                        'text-size': 12
                    }, paint: { 'text-color': '#000' }});
        
                    map.addLayer({ /* points simple*/ id: 'unclustered-point', type: 'circle', source: 'deces-points', filter: ['!', ['has', 'point_count']], paint: {
                        'circle-color': ['get', 'display_color'], 
                        'circle-radius': 10,
                        'circle-stroke-width': 1,
                        'circle-stroke-color': '#fff'
                    }});

                // Initialisation des timelines
                    initialiserTimeline('annee', ANNEES, 
                        ANNEE => ANNEE === ANNEE_INCONNUE_VALEUR ? 'Inconnu' : ANNEE.toString(), 
                        valeur => STATS_DECES.annee[valeur.toString()]
                    );
                
                    appliquerFiltreTemps();
                
                // Filtrage temporel   
                    function featurePasseFiltreTemps(feature) {
                        const a = parseInt(feature.properties.annee_deces);

                        if (currentIndexAnnee !== -1) {
                            const anneeActive = ANNEES[currentIndexAnnee];
                            if (a !== anneeActive) return false;
                        }

                        return true;
                    }

                // Gestion de l'int√©raction (l'orsqu'on clique clic sur un point)
                    map.on('click', 'unclustered-point', (e) => {
                        
                        const featureClicked = e.features[0];
                        const communeClickee = featureClicked.properties.commune_correcte; 
                        
                        // Filtrage et agr√©gation en m√©moire 
                        const statsParPays = allPointsFeatures
                            .filter(f =>
                                f.properties &&
                                f.properties.commune_correcte === communeClickee &&
                                featurePasseFiltreTemps(f) 
                            )
                            .reduce((acc, feature) => {
                                const pays = feature.properties.pays_naissance || PAYS_INCONNU_VALEUR;
                                if (!acc[pays]) acc[pays] = 0;
                                acc[pays]++;
                                return acc;
                            }, {});
                        
                        // Calculer le total des d√©c√®s pour le popup
                        const totalDecesCommune = Object.values(statsParPays).reduce((sum, count) => sum + count, 0);

                        // Affichage du Popup
                        const popupHTML = `
                            <div class="popup-header">
                                <h2 class="popup-commune"> Commune : ${communeClickee}</h2>
                            </div>
                            <div class="popup-body">
                                <div class="popup-stat">
                                    <span class="popup-stat-label">Nombre de soldat(s) d√©c√©d√©(s) : </span>
                                    <span class="popup-stat-value">${totalDecesCommune}</span>
                                </div>
                            </div>
                        `;

                        const ppopu = new maplibregl.Popup({
                            closeButton: true,
                            closeOnClick: true,
                            className: 'popup-france'
                        })
                            .setLngLat(e.lngLat)
                            .setHTML(popupHTML)
                            .addTo(map);

                        // Affichage et mise √† jour de la Sidebar Afrique (Division B)
                        toggleSidebar('right', true); 
                        
                        // Passage des statistiques agr√©g√©es √† la fonction d'affichage
                        updateAfriqueStatsSidebar(statsParPays); 
                    });
                
                    // Int√©raction lorsqu'on clique sur les clusters
                        map.on('mouseenter', 'unclustered-point', () => { map.getCanvas().style.cursor = 'pointer'; });
                        map.on('mouseleave', 'unclustered-point', () => { map.getCanvas().style.cursor = ''; });
                        
                        map.on('click', 'clusters', async(e) => {
                            const features = map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
                            const clusterId = features[0].properties.cluster_id;
                            if (!clusterId) return;
                            const zoom = await map.getSource('deces-points').getClusterExpansionZoom(clusterId);
                            map.easeTo({ center: features[0].geometry.coordinates, zoom : zoom + 0.5,});
                            });

                        map.on('mouseenter', 'clusters', () => {
                            map.getCanvas().style.cursor = 'pointer';
                        });
                        map.on('mouseleave', 'clusters', () => {
                            map.getCanvas().style.cursor = '';
                        });    
            });

        // Popup pour les pays africain
            const popupAfrique = new maplibregl.Popup({
            closeButton: false,
            closeOnClick: false
            });
    
        // Gestion des Donn√©es et des Couches de la Division B : Afrique
            mapAfrique.on('load', () => {
                mapAfrique.addSource('afrique-source', { type: 'geojson', data: AFRIQUE_GEOJSON_URL });
        
                mapAfrique.addLayer({
                    id: 'afrique-fill',
                    type: 'fill',
                    source: 'afrique-source',
                    paint: {
                        'fill-color': ['case', ['==', ['get', 'NOM_PAYS'], ''], '#ccc', '#ff0000'],
                        'fill-opacity': 0.7,
                        'fill-outline-color': '#000'
                    },
                    filter: ['==', 'NOM_PAYS', ''] 
                });

                mapAfrique.addLayer({
                    id: 'afrique-count',
                    type: 'symbol',
                    source: 'afrique-source',
                    layout: {
                        'text-field': '', 
                        'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                        'text-size': 14
                    },
                    paint: { 'text-color': '#000' }
                    });

                // Survol : afficher nom du pays
                mapAfrique.on('mousemove', 'afrique-fill', function (e) {

                    if (!e.features || e.features.length === 0) return;

                    const pays = e.features[0].properties.NOM_PAYS;

                    popupAfrique
                        .setLngLat(e.lngLat)
                        .setHTML(`<strong style="color:black">${pays}</strong>`)
                        .addTo(mapAfrique);
                });

                // Quand la souris sort du pays enleve le popup
                mapAfrique.on('mouseleave', 'afrique-fill', function () {
                    popupAfrique.remove();
                });
                mapAfrique.on('mouseenter', 'afrique-fill', () => {
                            mapAfrique.getCanvas().style.cursor = 'pointer';
                        });


            });

        // Mise √† jour de la Sidebar B avec les statistiques de la commune cliqu√©e 
            function updateAfriqueStatsSidebar(statsParPays) {
        
                const afriqueMessage = document.getElementById('afrique-message');
                const mapAfriqueDiv = document.getElementById('map-afrique-container');

                // mettre des couleurs dans les pays correspondants aux lieux de naissances des soldats de la commune cliqu√©e
                const paysPresent = Object.keys(statsParPays).filter(pays => pays !== PAYS_INCONNU_VALEUR);

                if (paysPresent.length === 0) {
                    mapAfriqueDiv.style.display = 'block';
                    afriqueMessage.style.display = 'block';
                    afriqueMessage.innerHTML = '<h2 style="color:white; margin-top: -6px;">Pays d\'origine non visualisable</h2><p style="color:white;">Le(s) soldat(s) morts ici ont un pays de naissance inconnu.</p>';
                    if (mapAfrique.getSource('afrique-source')) {
                        mapAfrique.setFilter('afrique-fill', ['==', 'NOM_PAYS', '']);
                    }
                    return;
                }

                // Afficher la carte
                mapAfriqueDiv.style.display = 'block';
        
                // Filtre les polygones de l'Afrique pour colorier les pays concern√©s
                mapAfrique.setFilter('afrique-fill',['in', ['get', 'NOM_PAYS'], ['literal', paysPresent]]);
                mapAfrique.setFilter('afrique-count',['in', ['get', 'NOM_PAYS'], ['literal', paysPresent]]);
                
                // Construire la liste des statistiques pour l'affichage textuel (d√©compte par pays)
                let statsHTML = `<h3 style="color:white; margin-top: 5px;">D√©c√®s par Pays de naissance dans cette commune :</h3><ul style="padding-left: 0;">`;
        
                // Trier par nombre de d√©c√®s d√©croissant
                const paysSorted = Object.entries(statsParPays)
                    .sort(([, countA], [, countB]) => countB - countA);

                paysSorted.forEach(([pays, count]) => {
                    const isAfrica = paysPresent.includes(pays);
                    // La couleur de fond de la liste indique si le pays est color√© sur la carte Afrique
                    statsHTML += `<li style="margin-bottom: 5px; color:white; background-color: ${isAfrica ? 'rgba(255, 0, 0, 0.3)' : 'rgba(100, 100, 100, 0.3)'}; padding: 3px 5px; border-radius: 3px;">
                                    <strong>${pays}:</strong> ${count} soldat(s)
                                </li>`;
                });
                statsHTML += `</ul>`;
        
                afriqueMessage.innerHTML = statsHTML;
            }    

        // Fonction pour basculer la sidebar (Division B)
            function toggleSidebar(id, forceOpen = false) {
                const elem = document.getElementById(id);
                const classes = elem.className.split(' ');
                const collapsed = classes.indexOf('collapsed') !== -1;

                // Si on veut forcer l'ouverture de la sidebar et qu'elle est d√©j√† ouverte, on sort.
                if (forceOpen && !collapsed) return;
    
                const padding = {};

                if (collapsed || forceOpen) {
                    // Enleve la classe qui cache la sidebar : elle s'ouvre
                    if (collapsed) classes.splice(classes.indexOf('collapsed'), 1);
                    padding[id] = 600; 
                } else {
                    // Ajoute la classe pour cacher la sidebar : elle se ferme
                    classes.push('collapsed');
                    padding[id] = 0;
                }

                elem.className = classes.join(' ');
    
                // Animation de la carte principale 
                map.easeTo({
                    padding,
                    duration: 1000 // 1000ms
                });

                if (collapsed || forceOpen) {
                    setTimeout(() => {
                        mapAfrique.resize();
                        console.log('mapAfrique.resize() ex√©cut√© pour afficher la carte Afrique.');
                    }, 1100); 
                }
            }  

        // Fonctions de la couche "concentration de d√©c√®s par d√©partement" -    
            // Fonction pour formater les nombres
            function formatNumber(num) {
                if (num === undefined || num === null) return 'N/A';
                return num.toLocaleString('fr-FR');
            }

            // Fonction pour arrondir √† 3 d√©cimales
            function roundToThree(num) {
                if (num === undefined || num === null) return 'N/A';
                return num.toFixed(3);
            }

            // Attendre que le style de la carte soit charg√©
            map.on('load', function() {
                // Ajouter la source des d√©partements (concentration de d√©c√®s)
                map.addSource('departements', {
                    type: 'geojson',
                    data: CONCENTRATION_DECES_URL
                });

                // Ajouter la couche des d√©partements
                map.addLayer({
                    id: 'departements-fill',
                    type: 'fill',
                    source: 'departements',
                    paint: {
                        'fill-color': [
                            'step',
                            ['get', 'proportion'],
                            '#fee5d8', 
                            0.014, '#fee5d8',
                            0.09950, '#fc8d62',
                            0.25250, '#d32020',
                            0.98650, '#67000d'
                        ],
                        'fill-opacity': 0.75,
                        'fill-outline-color': '#ffffff'
                    }
                });

                // Ajouter une couche de lignes pour les bordures des d√©partements
                map.addLayer({
                    id: 'departements-border',
                    type: 'line',
                    source: 'departements',
                    paint: {
                        'line-color': '#ffffff',
                        'line-width': 1,
                        'line-dasharray': [2, 2],
                        'line-opacity': 0.8
                    }
                });

                // Ajouter la source du contour de la France
                map.addSource('contour-france', {
                    type: 'geojson',
                    data: CONTOUR_FRANCE_URL
                });

                // Ajouter la couche du contour de la France
                map.addLayer({
                    id: 'contour-france-line',
                    type: 'line',
                    source: 'contour-france',
                    paint: {
                        'line-color': '#808080',
                        'line-width': 2.5,
                        'line-opacity': 1
                    }
                });

                // Gestionnaire d'√©v√©nements pour le survol
                map.on('mousemove', 'departements-fill', function(e) {
                    if (e.features.length > 0) {
                        const feature = e.features[0];
                        const props = feature.properties;
                        
                        // Mettre √† jour les informations affich√©es
                        document.getElementById('info').innerHTML = `
                            <p><b>D√©partement :</b> ${props.nom_departement || 'Non disponible'}</p>
                            <p><b>Nombre de d√©c√®s :</b> ${formatNumber(props.Total_deces)}</p>
                            <p><b>Superficie :</b> ${props.Surface ? props.Surface.toFixed(2) + ' km¬≤' : 'N/A'}</p>
                            <p><b>Concentration :</b> ${roundToThree(props.proportion)} d√©c√®s/km¬≤</p>
                        `;
                        
                        // Changer le curseur
                        map.getCanvas().style.cursor = 'pointer';
                    }
                });

                // R√©initialiser le curseur et les informations quand la souris quitte la zone
                map.on('mouseleave', 'departements-fill', function() {
                    document.getElementById('info').innerHTML = `
                        <p><b>Survolez un d√©partement</b></p>
                        <p>Les donn√©es s'afficheront ici</p>
                    `;
                    map.getCanvas().style.cursor = '';
                });

                // Zoom sur le d√©partement au clic
                map.on('click', 'departements-fill', function(e) {
                    if (e.features.length > 0) {
                        const bounds = new maplibregl.LngLatBounds();
                        
                        // Calculer les limites de la feature
                        const coordinates = e.features[0].geometry.coordinates;
                        
                        if (e.features[0].geometry.type === 'Polygon') {
                            coordinates[0].forEach(coord => {
                                bounds.extend(coord);
                            });
                        } else if (e.features[0].geometry.type === 'MultiPolygon') {
                            coordinates.forEach(polygon => {
                                polygon[0].forEach(coord => {
                                    bounds.extend(coord);
                                });
                            });
                        }
                        
                        // Animer le zoom vers les limites
                        map.fitBounds(bounds, {
                            padding: 50,
                            duration: 1000
                        });
                    }
                });

                // S'assurer que la couche des d√©partements est visible par d√©faut
                map.setLayoutProperty('departements-fill', 'visibility', 'visible');
                map.setLayoutProperty('departements-border', 'visibility', 'visible');
                map.setLayoutProperty('contour-france-line', 'visibility', 'visible');
            });

            // Gestion des erreurs de chargement
            map.on('error', function(e) {
                console.error('Erreur de carte:', e.error);
            });
        
        // Fonctions de la Timeline (Division C) -
            function initialiserTimeline(type, valeurs, getLabel, getCount) {
                const timeline = document.getElementById(`timeline-${type}`);
                timeline.innerHTML = ''; 

                const progressBar = document.createElement('div');
                progressBar.className = 'progress-bar';
                progressBar.id = `progress-${type}`;
                timeline.appendChild(progressBar);
        
                // D√©termine la source de couleurs
                const couleurSource = (type === 'annee') ? COULEURS_ANNEES : COULEURS_MOIS;
        
                valeurs.forEach((valeur, index) => {
                    let circle = document.createElement('div');
                    circle.className = 'timeline-item';
                    
                    const idValeur = valeur.toString();
                    circle.id = `${type}-${idValeur}`;
                    
                    const couleurDuCercle = couleurSource[idValeur] || '#CCCCCC'; // Couleur grise
                    
                    // Stocker la couleur cible dans un attribut data-color
                    circle.setAttribute('data-color', couleurDuCercle); 

                    // Ajout du Label (Ann√©e/Inconnu)
                    let label = document.createElement('span');
                    label.className = 'timeline-label';
                    label.textContent = getLabel(valeur); 
                    label.style.color = 'white'; 
                    circle.appendChild(label);

                    // Ajout du Compteur
                    let count = document.createElement('span');
                    count.className = 'timeline-count';
                    count.textContent = getCount(valeur).toLocaleString('fr-FR');
                    circle.appendChild(count);

                    circle.onclick = () => { selectTime(type, index); };
                    timeline.appendChild(circle);
                });
            }

            function selectTime(type, index) {
                let valeurs;
                if (type === 'annee') {
                    valeurs = ANNEES;
                } 
    
                const timeline = document.getElementById(`timeline-${type}`);

                // R√©cup√©rer l'√©l√©ment actif avant le masquage
                    const prevElement = timeline.querySelector('.timeline-item.active');

                    let isDeactivating = false;
                        if (type === 'annee' && currentIndexAnnee === index) {
                            // On clique sur l'ann√©e d√©j√† active : on d√©sactive
                            isDeactivating = true;
                            currentIndexAnnee = -1; // R√©initialiser √† "aucun filtre"
                        } else {
                            // On active une nouvelle ann√©e
                            if (type === 'annee') {
                                currentIndexAnnee = index;
                            }
                        }
    
                // Masquer tous les compteurs
                    timeline.querySelectorAll('.timeline-count').forEach(span => {
                        span.style.display = 'none';
                    });

                    if (prevElement) {
                        prevElement.classList.remove('active');
                        prevElement.style.backgroundColor = '#CCCCCC'; 
                    }
        
                    if (isDeactivating) {
                        appliquerFiltreTemps(); // Applique le filtre "aucun" pour tout r√©afficher
                        return; // Sort de la fonction
                    }
    
                // RETARDER L'AFFICHAGE DU CERCLE ET DU COMPTEUR
                    setTimeout(() => {
                        
                        const idValeur = valeurs[index].toString();
                        const selectedItem = document.getElementById(`${type}-${idValeur}`);
                        

                        if (selectedItem) {
                            // Appliquer la couleur stock√©e
                            const couleurActive = selectedItem.getAttribute('data-color');
                            selectedItem.style.backgroundColor = couleurActive;
                            
                            // Activation du cercle visuel
                            selectedItem.classList.add('active');
                            
                            // Affichage du compteur
                            const countSpan = selectedItem.querySelector('.timeline-count');
                            if (countSpan) {
                                countSpan.style.display = 'block';
                            }
                        }
            
                    }, 0.2);

                    appliquerFiltreTemps();

            }

            function defilerTemps(type, direction) {
                let currentIndex, maxIndex, valeurs;
                if (type === 'annee') {
                    currentIndex = currentIndexAnnee;
                    valeurs = ANNEES;
                }
                maxIndex = valeurs.length - 1; 

                let newIndex = currentIndex + direction;

                // Logique de la boucle des boutons "NEXT" et "PREVIOUS"
    
                    // CAS 1: G√©rer l'√©tat initial inactif (-1)
                    if (currentIndex === -1) {
                        // Au premier clic (Next ou Previous), on commence toujours par l'index 0.
                        newIndex = 0; 
                    }
    
                    // CAS 2: Boucle NEXT (Aller du dernier √©l√©ment au d√©but)
                    else if (newIndex > maxIndex) {
                        newIndex = -1; 
                    } 
    
                    // CAS 3: Boucle PREVIOUS (Aller du premier √©l√©ment √† la fin)
                    else if (newIndex < 0) {
                        newIndex = -1;
                    }
    

                selectTime(type, newIndex);

                defilerTemps()
            }    
  
            function appliquerFiltreTemps() {
                if (!map.getSource || !map.getSource('deces-points')) return;

                // D√©termination de l'√©tat actif bas√© sur les index globaux
                    const anneeActive = currentIndexAnnee !== -1;
                    const filtreTemporalActif = anneeActive;

                    let annee = anneeActive ? ANNEES[currentIndexAnnee] : null;

                // D√©terminer la couleur active pour les points individuels
                    let couleurActive = null;
                    if (annee !== null) {
                        couleurActive = COULEURS_ANNEES[annee.toString()] || null;
                    }

                // D√©finir la couleur du Clusters en premier 
                    // Si un filtre est actif, utilisez la couleur du filtre
                    if (filtreTemporalActif) { 
                        
                        map.setPaintProperty('clusters', 'circle-color', couleurActive);
                        map.setPaintProperty('cluster-count', 'text-color', '#000'); 
                    } else {
                        // Si inactif (currentIndex = -1), remet le style d'origine ci-dessous
                        map.setPaintProperty('clusters', 'circle-color', [
                            'step',
                            ['get', 'point_count'],
                            '#51bbd6', 100, '#f1f075', 750, '#f28cb1' 
                        ]);
                        map.setPaintProperty('cluster-count', 'text-color', '#000'); 
                    }

                    // Filtrage des donn√©es 
                        const filtered = {
                            type: "FeatureCollection",
                            features: allPointsFeatures
                                .filter(f => {
                                    const a = parseInt(f.properties.annee_deces);

                                    if (annee !== null && a !== annee) return false;
                                    return true;
                                })
                                .map(f => {
                                    const ff = JSON.parse(JSON.stringify(f));
                    
                                    // Si un filtre est actif, on utilise la couleur du filtre.
                                        if (couleurActive) {
                                            ff.properties.display_color = couleurActive;
                                        } else {
                                            // Sinon on utilise la couleur_annee stock√©e dans le GeoJSON
                                            ff.properties.display_color = ff.properties.couleur_annee || '#CCCCCC';
                                        }
                                        return ff;
                                })
                        };

                    // Mettre √† jour la source (reconstruit les clusters pour ce sous-ensemble)
                        map.getSource('deces-points').setData(filtered);


                    // S'assurer que la couche 'unclustered-point' utilise bien display_color
                        if (map.getLayer('unclustered-point')) {
                            map.setPaintProperty('unclustered-point', 'circle-color', ['get', 'display_color']);
                        }

                    // Mise √† jour visuelle de la progress bar / timeline si besoin (retir√© car g√©r√© par selectTime)
                        if (currentIndexAnnee !== -1) updateProgressBar('annee', currentIndexAnnee, ANNEES.length);
            }

            function togglePopup() {
            const popup = document.getElementById('popup');
            if (popup.style.display === 'none') {
                popup.style.display = 'block';
                // Forcer la r√©animation
                popup.style.animation = 'none';
                setTimeout(() => {
                    popup.style.animation = 'popupSlideIn 0.3s ease-out';
                }, 10);
            } else {
                popup.style.display = 'none';
            }
            }

        // Popup informatif √† l'ouverture de la visualisation ===
            let currentSection = 0;
            const totalSections = 2;

            function updateSection(index) {
                // Cacher toutes les sections
                document.querySelectorAll('.popup-content-section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // Afficher la section actuelle
                document.getElementById(`section${index + 1}`).classList.add('active');
                
                // Mettre √† jour les dots
                document.querySelectorAll('.popup-dot').forEach((dot, i) => {
                    dot.classList.toggle('active', i === index);
                });
                
                // Mettre √† jour les boutons
                document.getElementById('btnPrevSection').disabled = index === 0;
                document.getElementById('btnNextSection').textContent = index === totalSections - 1 ? 'Commencer' : 'Suivant';
                
                currentSection = index;
            }

            function nextSection() {
                if (currentSection < totalSections - 1) {
                    updateSection(currentSection + 1);
                } else {
                    closeInfoPopup();
                }
            }

            function previousSection() {
                if (currentSection > 0) {
                    updateSection(currentSection - 1);
                }
            }

            function goToSection(index) {
                updateSection(index);
            }

            function closeInfoPopup() {
                document.getElementById('popupOverlay').classList.add('hidden');
            }

            // Fermer avec la touche √âchap
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const popup = document.getElementById('popupOverlay');
                    if (popup && !popup.classList.contains('hidden')) {
                        closeInfoPopup();
                    }
                }
            });


    </script>
</body>
</html>